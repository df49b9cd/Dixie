# Project Nika Protocol Specification

## Overview

Nika uses a lightweight, line-delimited JSON protocol over the host process stdin/stdout streams. Messages follow Language Server Protocol framing for ease of reuse and tooling compatibility.

```
Content-Length: <byte-length>\r\n
\r\n
<JSON payload>
```

- Encoding: UTF-8.
- Direction: plugin ➜ host (requests), host ➜ plugin (responses, notifications).
- Each request carries a `requestId` string generated by the plugin.
- Host responses must echo the `requestId` to allow correlation.

## Message Envelope

```jsonc
{
  "version": 1,
  "type": "request" | "response" | "notification",
  "requestId": "uuid-or-numeric-string",          // required for request/response
  "command": "initialize" | "format" | "shutdown" | "ping" | "log" | "error",
  "payload": {}                                   // command-specific shape
}
```

- `version`: protocol major version. Breaking changes increment this number and the plugin refuses incompatible hosts.
- `type`: differentiates request/response/notification.
- `command`: operation name. For responses, mirrors the originating request command.
- `payload`: see command sections.

## Commands

### initialize

- **Direction:** request (plugin ➜ host)
- **Purpose:** establish capabilities and validate compatibility.
- **Payload (request):**

  ```jsonc
  {
    "clientVersion": "0.1.0",
    "hostBinaryVersion": "0.1.0",     // plugin expectation
    "platform": "darwin-arm64",
    "options": {
      "roslynLanguageVersion": "preview",
      "msbuildSdksPath": null
    }
  }
  ```

- **Payload (response):**

  ```jsonc
  {
    "ok": true,
    "hostVersion": "0.1.0",
    "roslynLanguageVersion": "preview",
    "capabilities": {
      "supportsRangeFormatting": false,
      "supportsDiagnostics": true,
      "supportsTelemetry": false
    }
  }
  ```

- On incompatibility, host returns `ok: false` with `reason` and closes the stream.

### format

- **Direction:** request
- **Purpose:** format an entire document or specific span.
- **Payload (request):**

  ```jsonc
  {
    "filePath": "/abs/path/File.cs",
    "content": "class Foo { }",
    "range": { "start": 0, "end": 12 },       // optional
    "options": {
      "printWidth": 100,
      "tabWidth": 4,
      "useTabs": false,
      "endOfLine": "lf"
    },
    "sessionId": "uuid",
    "traceToken": "optional-correlation-id"
  }
  ```

- **Payload (response):**

  ```jsonc
  {
    "ok": true,
    "formatted": "class Foo\n{\n}\n",
    "diagnostics": [
      {
        "severity": "warning",
        "message": "Trailing comma preserved.",
        "start": 42,
        "end": 43
      }
    ],
    "metrics": {
      "elapsedMs": 37,
      "parseDiagnostics": 0
    }
  }
  ```

- On failure (`ok: false`) host must supply `errorCode`, `message`, and optionally `details`.

### ping

- **Direction:** request
- **Purpose:** determine if host is responsive and retrieve heartbeat metrics.
- **Payload (request):** `{ "timestamp": 1700000000 }`
- **Payload (response):**

  ```jsonc
  {
    "ok": true,
    "timestamp": 1700000000,
    "uptimeMs": 120000,
    "activeRequests": 0
  }
  ```

### shutdown

- **Direction:** request
- **Purpose:** gracefully tear down host process.
- **Payload (request):** `{ "reason": "idle-timeout" }`
- **Payload (response):** `{ "ok": true }`
- Host should exit after sending the response.

### error (notification)

- **Direction:** host ➜ plugin
- **Purpose:** surface fatal errors that prevent future work.
- **Payload:**

  ```jsonc
  {
    "severity": "fatal" | "recoverable",
    "errorCode": "HOST_CRASH",
    "message": "Unhandled exception",
    "details": {
      "stack": "System.Exception: ..."
    }
  }
  ```

- Plugin must treat `fatal` notifications as a signal to dispose of the host.

### log (notification)

- **Direction:** host ➜ plugin
- **Purpose:** optional structured logging.
- **Payload:**

  ```jsonc
  {
    "level": "info" | "warn" | "error" | "debug",
    "message": "Formatting request completed",
    "traceToken": "uuid",
    "context": {
      "elapsedMs": 37
    }
  }
  ```

## Error Codes

- `HOST_VERSION_MISMATCH`: host binary version incompatible with plugin.
- `PARSE_ERROR`: Roslyn could not parse the supplied source.
- `FORMAT_FAILURE`: Roslyn formatter threw unexpected exception.
- `INVALID_ARGUMENT`: request payload failed validation.
- `INTERNAL_ERROR`: unhandled host exception.

## State Machine

1. Plugin spawns host, sends `initialize`.
2. Host replies `ok: true` ➜ session enters **Ready** state.
3. Plugin issues `format` requests; host processes them sequentially (current design).
4. Plugin periodically sends `ping` to detect hangs; if timeout occurs, plugin terminates host and respawns.
5. Plugin sends `shutdown` on editor exit, idle timeout, or project closure.

## Backward Compatibility

- Protocol `version` increments on breaking change. Plugin rejects lower versions it cannot understand.
- Hosts may send additional fields; plugin must ignore unknown properties.
- Requests include `capabilities` negotiation to detect optional features (e.g., range formatting) without breaking older hosts.

## Testing Strategy

- JSON schema validation for each command (TS `zod` definitions, C# `JsonSerializer` attributes).
- Reference implementations:
  - TypeScript schema (`packages/prettier-plugin-nika/src/protocol.ts`) exposes `zod` models consumed by the plugin.
  - C# record models (`src/Nika.Host/ProtocolModels.cs`) ensure host-side handlers deserialize with full type coverage.
- Golden request/response fixtures under `tests/protocol`.
- Integration tests simulate timeouts, malformed payloads, and host restarts.
